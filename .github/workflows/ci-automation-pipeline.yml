name: CI_80LV

on:
  workflow_dispatch:
    inputs:
      target_env:
        description: "Target environment"
        required: true
        default: "80LV_PROD"
        type: choice
        options: [80LV_PROD, 80LV_QA, 80LV_DEV]
  push:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      # ENV: ${{ github.event.inputs.target_env }}
        ENV: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && '80LV_PROD' || github.event.inputs.target_env }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

# =============================================
# âœ… Caches npmâ€™s download cache automatically
# =============================================
      - name: Setup NodeJS
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            **/package-lock.json
# ========================
# ðŸ”½ Install dependencies
# ========================
      - name: Install dependencies
        run: npm ci
# =========================================
# âœ… Cache Playwright browsers (Linux path)
# =========================================
      - name: Cache Playwright Browsers
        id: cache-pw
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: pw-browsers-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: pw-browsers-${{ runner.os }}-
# ======================================
# ðŸ”½ Install browsers only if cache miss
# ======================================
      - name: Install Playwright Browsers
        if: steps.cache-pw.outputs.cache-hit != 'true'
        run: npx playwright install
# ===============================
# âœ… Cache & Install Allure
# ===============================
     # 
      - name: Cache Allure CLI
        id: cache-allure
        uses: actions/cache@v3
        with:
          path: /opt/allure-2.24.0
          key: allure-${{ runner.os }}-2.24.0
          restore-keys: allure-${{ runner.os }}-

      # âœ… Install when cache MISS
      - name: Install Allure CLI
        if: steps.cache-allure.outputs.cache-hit != 'true'
        run: |
          sudo apt update
          sudo apt install -y curl unzip
          curl -L -o allure.tgz https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz
          sudo tar -zxvf allure.tgz -C /opt/
          # add to PATH for subsequent steps
          echo "/opt/allure-2.24.0/bin" >> $GITHUB_PATH

      # âœ… Use cached Allure (also add PATH)
      - name: Setup Allure from cache
        if: steps.cache-allure.outputs.cache-hit == 'true'
        run: echo "/opt/allure-2.24.0/bin" >> $GITHUB_PATH

      # âœ… Verify Allure (separate step so PATH works)
      - name: Verify Allure
        run: allure --version

      - name: Clear Previous Allure Results
        run: |
          rm -rf allure-results allure-report allure-history || true
          mkdir -p allure-results allure-report allure-history
# ========================================================
# ðŸ”‘ Create a .env for the tests from Variables + Secrets
# ========================================================
      - name: Generate .env for tests
        shell: bash
        run: |
          set -e
          echo "BASE_URL_80LV_PROD=${{ vars.BASE_URL_80LV_PROD }}"   >> .env
          echo "BASE_URL_80LV_QA=${{ vars.BASE_URL_80LV_QA }}"       >> .env
          echo "TALENT_EMAIL=${{ secrets.TALENT_EMAIL }}"               >> .env
          echo "TALENT_PASSWORD=${{ secrets.TALENT_PASSWORD }}"         >> .env
          echo "RECRUITER_EMAIL=${{ secrets.RECRUITER_EMAIL }}"         >> .env
          echo "RECRUITER_PASSWORD=${{ secrets.RECRUITER_PASSWORD }}"   >> .env
          echo "ENV=${ENV}" >> .env
          echo "----- .env (sanitized) -----"
          grep -E '^(ENV|BASE_URL)' .env || true
          echo "----------------------------"
# ============
# ðŸ”½ Run Test
# ============
      - name: Run Playwright Tests
        run: npx cross-env ENV=${ENV} playwright test
# =====================================================
# ðŸ”½ Always run uploads even if global setup/tests fail
# =====================================================
      - name: Upload Global Setup Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: global-setup-artifacts
          path: artifacts/global-setup/**/*
          if-no-files-found: ignore  
# ===============================
# ðŸ”½ Allure GitHub Pages publish
# ===============================
      - name: Check gh-pages existence
        id: has-ghpages
        shell: bash
        run: |
          if git ls-remote --heads "https://github.com/${{ github.repository }}.git" gh-pages | grep gh-pages >/dev/null; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "âœ… gh-pages exists"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "â„¹ï¸ gh-pages does not exist yet (first deploy)"
          fi

      # âœ… Only checkout gh-pages when it actually exists
      - name: Checkout gh-pages (history restore)
        if: always() && steps.has-ghpages.outputs.exists == 'true'
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          persist-credentials: false

      - name: Restore Allure history
        if: always()
        run: |
          if [ -d gh-pages/history ]; then
            echo "ðŸ” Restoring Allure history from gh-pages/history"
            rm -rf allure-history
            mkdir -p allure-history
            cp -r gh-pages/history allure-history
          else
            echo "â„¹ï¸ No previous history found"
          fi

      - name: Generate Allure Report for Pages
        if: always()
        run: |
          allure generate allure-results --clean -o allure-report
          ls -lah allure-report || true
# ===============================
# ðŸ”½ Upload Videos Of Tests
# ===============================
      - name: Upload Allure Report Videos 
        if: always() 
        uses: actions/upload-artifact@v4 
        with: 
          name: allure-videos 
          path: allure-report/data/attachments/*.webm 
          if-no-files-found: ignore
# ===============================
# ðŸ”½ Upload Failure Screenshots 
# ===============================
      - name: Upload Failure Screenshots
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: failure-screenshots
          path: allure-report/data/attachments/*.png
          retention-days: 7
          if-no-files-found: ignore

      - name: Setup Pages
        if: always()
        uses: actions/configure-pages@v5

      - name: Upload Allure site to Pages
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: allure-report

      - name: Deploy to GitHub Pages
        if: always()
        id: deploy
        uses: actions/deploy-pages@v4

      - name: Add Report Link to Summary
        if: always()
        run: |
          echo "## âœ… Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[ðŸ‘‰ Click to view report](https://ashfaq-viva.github.io/80lv.webAutomation)" >> $GITHUB_STEP_SUMMARY

# ===============================
# ðŸ”½ Sent Email of results
# ===============================
      - name: Setup mailutils and jq
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: bsd-mailx jq jq
          version: 1.0

      - name: Configure mailx for SMTP
        run: |
          echo "set smtp=smtps://smtp.gmail.com:465" >> ~/.mailrc
          echo "set smtp-auth=login" >> ~/.mailrc
          echo "set smtp-auth-user=${{ secrets.SMTP_USERNAME }}" >> ~/.mailrc
          echo "set smtp-auth-password=${{ secrets.SMTP_PASSWORD }}" >> ~/.mailrc
          echo "set ssl-verify=ignore" >> ~/.mailrc

      - name: Extract Key Test Summary
        run: |
          if [ -f allure-report/widgets/summary.json ]; then
              jq -r '"80LV Automation Report: \(.reportName) | Passed: \(.statistic.passed) | Failed: \(.statistic.failed) | Total: \(.statistic.total)"' allure-report/widgets/summary.json > summary.txt
              echo "" >> summary.txt
              echo "ðŸ‘‰ View full report: https://ashfaq-viva.github.io/80lv.webAutomation" >> summary.txt
          else
              echo "No summary found. Check if tests executed correctly." > summary.txt
              echo "" >> summary.txt
              echo "ðŸ‘‰ View full report: https://ashfaq-viva.github.io/80lv.webAutomation" >> summary.txt
          fi
      - name: Ensure mail client present
        run: |
          if command -v mailx >/dev/null 2>&1; then
            echo "mailx present"
          elif command -v mail >/dev/null 2>&1; then
            echo "mail present"
          else
            echo "No mail client found, installing bsd-mailx..."
            sudo apt-get update
            sudo apt-get install -y bsd-mailx
          fi
      - name: Send Email with Allure Report
        run: |
          cat summary.txt | mailx -s "80LV Automation Test Report Summary"  ashfaq.ahmed@vivasoftltd.com
